<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AleXShare</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1720;
      --text: #e6eef6;
      --muted: #95a0b0;
      --accent: #6ee7b7;
      --accent-hover: #44d2a6;
      --glass: rgba(255,255,255,0.03);
      --shadow: 0 8px 32px rgba(0,0,0,0.5);
      --transition: all 0.3s ease;
    }
    [data-theme="light"] {
      --bg: #f5f7fa;
      --panel: #ffffff;
      --text: #0b0b0b;
      --muted: #4b5563;
      --accent: #0b84ff;
      --accent-hover: #0070f3;
      --glass: rgba(0,0,0,0.03);
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: var(--transition);
    }
    body {
      display: flex;
      flex-direction: column;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    @keyframes slideInLeft {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOutLeft {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(-100%); opacity: 0; }
    }
    @keyframes loadingSpinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.5s ease-out forwards;
    }
    .animate-pulse {
      animation: pulse 0.9s ease;
    }
    .animate-slideInLeft {
      animation: slideInLeft 0.4s ease-out forwards;
    }
    .animate-slideOutLeft {
      animation: slideOutLeft 0.4s ease-out forwards;
    }
    .loading {
      animation: loadingSpinner 1s linear infinite;
    }
    .animate-bounce {
      animation: bounce 1s ease;
    }
    .btn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .btn:active {
      transform: translateY(0);
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      background: var(--glass);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 10;
      transition: var(--transition);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 1.2rem;
    }
    .logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 900;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: var(--transition);
    }
    .logo:hover {
      transform: rotate(360deg);
    }
    .burger {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--glass);
      transition: var(--transition);
    }
    .burger:hover {
      background: rgba(255,255,255,0.1);
    }
    .burger .lines {
      width: 20px;
      height: 12px;
      position: relative;
    }
    .burger .lines::before, .burger .lines::after, .burger .lines div {
      content: "";
      position: absolute;
      height: 2px;
      background: var(--accent);
      left: 0;
      right: 0;
      border-radius: 2px;
      transition: var(--transition);
    }
    .burger .lines::before { top: 0; }
    .burger .lines div { top: 5px; }
    .burger .lines::after { bottom: 0; }
    .burger.open .lines { transform: rotate(90deg); }
    .burger.open .lines::before { transform: translateY(5px) rotate(45deg); }
    .burger.open .lines::after { transform: translateY(-5px) rotate(-45deg); }
    .burger.open .lines div { opacity: 0; }
    .side {
      position: fixed;
      top: 80px;
      left: 24px;
      width: 250px;
      padding: 20px;
      border-radius: 12px;
      background: var(--glass);
      box-shadow: var(--shadow);
      transform: translateX(-110%);
      transition: transform 0.4s ease;
      backdrop-filter: blur(12px);
      z-index: 9;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }
    .side::-webkit-scrollbar {
      width: 6px;
    }
    .side::-webkit-scrollbar-track {
      background: var(--glass);
      border-radius: 3px;
    }
    .side::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }
    .side::-webkit-scrollbar-thumb:hover {
      background: var(--accent-hover);
    }
    .side.open {
      transform: translateX(0);
      animation: slideInLeft 0.4s ease-out forwards;
    }
    .side:not(.open) {
      animation: slideOutLeft 0.4s ease-out forwards;
    }
    .side h3 {
      margin: 0 0 16px;
      font-size: 1.1rem;
    }
    .side h4 {
      margin: 16px 0 8px;
      font-size: 0.95rem;
    }
    .codebox {
      display: flex;
      gap: 8px;
      align-items: center;
      background: var(--glass);
      padding: 10px;
      border-radius: 8px;
      transition: var(--transition);
    }
    .code {
      font-family: monospace;
      padding: 6px 10px;
      border-radius: 6px;
      background: rgba(0,0,0,0.1);
      flex: 1;
    }
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: 0;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      transition: var(--transition);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid var(--muted);
      color: var(--muted);
      box-shadow: none;
    }
    .btn.ghost:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    .switch {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
    }
    main {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 32px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    main.visible {
      opacity: 1;
    }
    .container {
      max-width: 1200px;
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
    }
    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }
      .side {
        left: 16px;
        width: calc(100% - 32px);
      }
    }
    .card {
      background: var(--panel);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    .card:hover {
      transform: translateY(-4px);
    }
    h2, h3, h4 {
      margin: 0 0 12px;
      color: var(--text);
    }
    .small {
      font-size: 0.875rem;
      color: var(--muted);
    }
    input, textarea {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--glass);
      background: var(--glass);
      color: var(--text);
      font-family: inherit;
      transition: var(--transition);
      box-sizing: border-box;
      width: 100%;
    }
    #username, #password {
      width: 100%;
      max-width: 400px;
      margin: 10px auto 0 auto;
    }
    input:focus, textarea:focus {
      border-color: var(--accent);
      outline: none;
    }
    #authContainer {
      max-width: 480px;
      width: 100%;
    }
    #authSection {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #authSection input {
      width: 100%;
    }
    #authSection .btn-group {
      display: flex;
      gap: 12px;
    }
    #editorContainer {
      display: none;
    }
    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .toolbar button {
      padding: 8px 12px;
      font-size: 0.875rem;
    }
    textarea#editor {
      min-height: 400px;
      resize: vertical;
      line-height: 1.6;
      width: 100%;
      max-width: 800px;
      margin-left: auto; margin-right: auto;
    }
    .preview {
      background: var(--glass);
      padding: 16px;
      border-radius: 12px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--glass);
      transition: var(--transition);
      display: none;
    }
    .preview::-webkit-scrollbar {
      width: 6px;
    }
    .preview::-webkit-scrollbar-track {
      background: var(--glass);
      border-radius: 3px;
    }
    .preview::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }
    .preview::-webkit-scrollbar-thumb:hover {
      background: var(--accent-hover);
    }
    .options-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      margin: 16px 0;
    }
    .linkbox {
      background: var(--glass);
      padding: 8px;
      border-radius: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 1;
      display: none;
    }
    .linkbox input {
      border: 0;
      background: transparent;
      color: var(--text);
      font-family: monospace;
      flex: 1;
    }
    footer {
      text-align: center;
      padding: 16px;
      color: var(--muted);
      font-size: 0.875rem;
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--glass);
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      display: inline-block;
      animation: loadingSpinner 1s linear infinite;
      margin-right: 8px;
    }
    .word-count {
      font-size: 0.75rem;
      color: var(--muted);
      text-align: right;
      margin-top: 8px;
    }
    .draft-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--accent);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.875rem;
      box-shadow: var(--shadow);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .draft-indicator.show {
      opacity: 1;
    }
    .keyboard-shortcut {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--muted);
      margin-left: auto;
    }
    .password-strength {
      width: 100%;
      height: 4px;
      background: var(--glass);
      border-radius: 2px;
      margin-top: 4px;
      transition: width 0.3s ease;
    }
    .strength-weak { background: #ef4444; }
    .strength-medium { background: #f59e0b; }
    .strength-strong { background: #10b981; }
    .note-item {
      padding: 8px;
      background: var(--glass);
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .note-item a {
      flex: 1;
      color: var(--accent);
      text-decoration: none;
    }
    .note-item small {
      flex-shrink: 0;
      color: var(--muted);
    }
    .note-item .icons {
      display: flex;
      gap: 8px;
      margin-left: 8px;
    }
    .edit-icon, .delete-icon, .share-icon {
      cursor: pointer;
      font-size: 1rem;
      color: var(--muted);
      transition: color 0.3s ease;
    }
    .edit-icon:hover {
      color: var(--accent);
    }
    .delete-icon:hover {
      color: #ef4444;
    }
    .share-icon:hover {
      color: var(--accent);
    }
    .change-section {
      margin-top: 16px;
      display: none;
    }
    .change-section.show {
      display: block;
    }
    .change-section input {
      width: 100%;
      margin-bottom: 8px;
    }
    .change-section button {
      width: 100%;
    }
    @media (max-width: 768px) {
      main {
        padding: 16px;
      }
      .side {
        width: 95%;
        left: 0;
        border-radius: 0;
        max-height: calc(100vh - 80px);
        top: 80px;
        padding: 16px;
      }
      .side input,
      .side button {
        width: 100%;
        box-sizing: border-box;
      }
      .codebox {
        flex-direction: column;
      }
      .code {
        width: 100%;
        text-align: center;
      }
      .container {
        padding: 0;
        gap: 16px;
      }
      .card {
        padding: 16px;
        border-radius: 12px;
      }
      .toolbar {
        justify-content: flex-start;
        gap: 4px;
      }
      .toolbar button {
        padding: 6px 10px;
        font-size: 0.8rem;
      }
      .options-row {
        flex-direction: column;
        gap: 12px;
      }
      .linkbox {
        flex-direction: column;
      }
      .linkbox input {
        width: 100%;
        text-align: center;
      }
      .btn-group {
        flex-direction: column;
        gap: 8px;
      }
      #authSection .btn-group button {
        width: 100%;
      }
    }
    #viewerContainer {
      display: none;
      max-width: 800px;
      width: 100%;
    }
    #viewerPreview {
      background: var(--glass);
      padding: 16px;
      border-radius: 12px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--glass);
      transition: var(--transition);
    }
    #viewerPreview::-webkit-scrollbar {
      width: 6px;
    }
    #viewerPreview::-webkit-scrollbar-track {
      background: var(--glass);
      border-radius: 3px;
    }
    #viewerPreview::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }
    #viewerPreview::-webkit-scrollbar-thumb:hover {
      background: var(--accent-hover);
    }
    #viewerPrompt {
      margin-top: 16px;
      text-align: center;
      color: var(--muted);
    }
    #viewerPasswordContainer {
      display: none;
      max-width: 480px;
      width: 100%;
      margin-top: 16px;
    }
    #viewerPassword {
      width: 100%;
    }
    #viewerSubmitPassword {
      width: 100%;
      margin-top: 12px;
    }
    .viewer-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 768px) {
      .viewer-buttons {
        flex-direction: column;
      }
      .viewer-buttons button {
        width: 100%;
      }
    }
    .visibility-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .visibility-icon {
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--muted);
    }
    .visibility-icon:hover {
      color: var(--accent);
    }
    .tooltip-panel {
      position: absolute;
      background: var(--glass);
      backdrop-filter: blur(10px);
      padding: 12px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      display: none;
      z-index: 10;
      max-width: 300px;
    }
    .tooltip-panel.show {
      display: block;
    }
    #saveNote {
      color: #000;
    }
    .confirm-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--panel);
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      z-index: 20;
      display: none;
      text-align: center;
    }
    .confirm-panel.show {
      display: block;
    }
    .confirm-panel button {
      margin-top: 12px;
    }
    #privateMessage {
      font-size: 1.2rem;
      text-align: center;
      padding: 20px;
    }
    .copied-message {
      display: none;
      color: var(--accent);
      margin-left: 8px;
    }
  </style>
</head>
<body data-theme="dark">
  <header>
    <div class="brand">
      <div class="logo">AX</div>
      <div>AleXShare</div>
    </div>
    <div style="display: flex; gap: 16px; align-items: center;">
      <div id="userDisplay" class="small">Non connesso</div>
      <div id="burger" class="burger" role="button" title="Menu">
        <div class="lines"><div></div></div>
      </div>
    </div>
  </header>
  <div id="side" class="side" aria-hidden="true">
    <h3>Impostazioni</h3>
    <div id="loggedInSettings">
      <div class="small">Codice di recupero</div>
      <div class="codebox">
        <div id="regCode" class="code">—</div>
        <button id="copyReg" class="btn ghost">Copia</button>
      </div>
      <div id="changeUsernameSection" class="change-section">
        <h4>Cambia Username</h4>
        <input id="newUsernameInput" placeholder="Nuovo username" />
        <button id="changeUsername" class="btn ghost">Cambia</button>
      </div>
      <div id="changePasswordSection" class="change-section">
        <h4>Cambia Password</h4>
        <input id="currentPasswordInput" placeholder="Password attuale" type="password" />
        <input id="newPasswordInput" placeholder="Nuova password" type="password" />
        <div id="changePassStrength" style="display: none;">
          <div class="password-strength"></div>
        </div>
        <button id="changePassword" class="btn ghost">Cambia</button>
      </div>
      <div class="switch">
        <label class="small">Light mode</label>
        <button id="toggleTheme" class="btn ghost">Attiva</button>
      </div>
      <button id="logoutBtn" class="btn ghost" style="margin-top: 16px;">Logout</button>
    </div>
    <div id="notLoggedMenu" style="display: none;">
      <button id="sideLogin" class="btn" style="margin-bottom: 8px; width: 100%;">Login</button>
      <button id="sideSignup" class="btn ghost" style="width: 100%;">Registrati</button>
    </div>
  </div>
  <main id="mainContent">
    <div id="authContainer" class="animate-fadeIn">
      <div class="card">
        <h2>Benvenuto in AleXShare</h2>
        <div class="small">Accedi o registrati per condividere testi sicuri.</div>
        <div id="authSection">
          <input id="username" placeholder="Username" />
          <input id="password" placeholder="Password" type="password" />
          <div id="passwordStrength" style="display: none;">
            <div class="password-strength"></div>
          </div>
          <div class="btn-group">
            <button id="signupBtn" class="btn">Registrati</button>
            <button id="loginBtn" class="btn ghost">Login</button>
          </div>
          <button id="forgotBtn" class="btn ghost" style="width: 100%; margin-top: 12px;">Password dimenticata?</button>
        </div>
        <div id="recoveryStep" style="display: none; margin-top: 16px;">
          <div class="small">Inserisci il codice di recupero</div>
          <input id="recoveryInput" placeholder="Codice di recupero" />
          <button id="recoverySubmit" class="btn" style="width: 100%; margin-top: 12px;">Invia</button>
        </div>
        <div id="resetStep" style="display: none; margin-top: 16px;">
          <div class="small">Reimposta credenziali</div>
          <input id="newUser" placeholder="Nuovo username (opzionale)" />
          <input id="newPass" placeholder="Nuova password" type="password" />
          <div id="newPasswordStrength" style="display: none;">
            <div class="password-strength"></div>
          </div>
          <button id="doReset" class="btn" style="width: 100%; margin-top: 12px;">Aggiorna</button>
        </div>
        <div id="afterRegister" style="display: none; margin-top: 16px;">
          <div class="small">Salva questo codice di recupero</div>
          <div class="codebox">
            <div id="generatedCode" class="code">—</div>
            <button id="copyGenerated" class="btn ghost">Copia</button>
          </div>
        </div>
      </div>
    </div>
    <div id="editorContainer" class="container animate-fadeIn">
      <section class="card">
        <button id="newNote" class="btn">Nuovo</button>
        <h3>Editor Markdown Avanzato</h3>
        <div class="toolbar">
          <button class="btn ghost" data-act="bold"><b>B</b></button>
          <button class="btn ghost" data-act="italic"><i>I</i></button>
          <button class="btn ghost" data-act="h1">H1</button>
          <button class="btn ghost" data-act="h2">H2</button>
          <button class="btn ghost" data-act="h3">H3</button>
          <button class="btn ghost" data-act="quote">&gt;</button>
          <button class="btn ghost" data-act="code">&lt;/&gt;</button>
          <button class="btn ghost" data-act="codeblock">Code Block</button>
          <button class="btn ghost" id="insertLink">Link</button>
          <button class="btn ghost" id="insertImage">Immagine</button>
          <button class="btn ghost" id="insertList">Lista</button>
          <button class="btn ghost" id="insertTable">Tabella</button>
          <button class="btn ghost" id="clearFormat">Cancella</button>
        </div>
        <textarea id="editor" placeholder="Scrivi qui il tuo testo..."></textarea>
        <div id="saveStatus" class="small">Non salvato</div>
        <div class="word-count" id="wordCount">0 parole | 0 caratteri</div>
        <div class="options-row">
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <label class="small"><input type="checkbox" id="protectPwd"> Proteggi con password</label>
            <input id="notePwd" placeholder="Password" style="display: none;" />
            <div id="notePasswordStrength" style="display: none;">
              <div class="password-strength"></div>
            </div>
            <label class="small"><input type="checkbox" id="useExpiry"> Scadenza</label>
            <input id="expiryDate" type="datetime-local" style="display: none;" />
          </div>
          <div class="visibility-group">
            <div class="small">Visibilità:</div>
            <select id="visibilitySelect">
              <option value="pubblica">Pubblica</option>
              <option value="privata">Privata</option>
            </select>
            <span class="visibility-icon" id="visibilityIcon">?</span>
            <div class="tooltip-panel" id="visibilityTooltip">
              <p>Pubblica: Chiunque con il link può visualizzare il testo.</p>
              <p>Privata: Solo tu puoi visualizzare il testo, anche con il link.</p>
            </div>
          </div>
        </div>
        <div class="options-row">
          <div class="linkbox">
            <input id="shareLink" readonly placeholder="Link condiviso" />
            <button id="copyShare" class="btn ghost">Copia</button>
          </div>
          <div style="display: flex; gap: 12px;">
            <button id="saveNote" class="btn">Salva <span id="saveSpinner" class="spinner" style="display: none;"></span></button>
            <button id="saveDraftBtn" class="btn ghost">Salva Bozza</button>
            <button id="previewBtn" class="btn ghost">Anteprima</button>
            <button id="exportMarkdown" class="btn ghost">Esporta MD</button>
          </div>
        </div>
        <div id="preview" class="preview"></div>
      </section>
      <aside class="card">
        <h3>I tuoi link</h3>
        <div class="change-section show">
          <h4>Aggiungi link</h4>
          <input id="linkTitle" placeholder="Titolo" />
          <input id="linkUrl" placeholder="Link" />
          <button id="addLink" class="btn ghost">Aggiungi</button>
        </div>
        <div id="userNotes"></div>
        <button id="loadMoreLinks" class="btn ghost" style="margin-top: 16px; display: none;">Altro</button>
      </aside>
    </div>
    <div id="viewerContainer" class="animate-fadeIn">
      <div class="card">
        <div id="viewerPasswordContainer">
          <div class="small">Password richiesta per visualizzare il testo.</div>
          <input id="viewerPassword" placeholder="Password" type="password" />
          <button id="viewerSubmitPassword" class="btn">Invia</button>
        </div>
        <div id="viewerPreview"></div>
        <div id="viewerPrompt" class="small">Vuoi creare un testo condivisibile anche tu? Registrati!</div>
        <div class="viewer-buttons">
          <button id="viewerLoginBtn" class="btn ghost">Login</button>
          <button id="viewerSignupBtn" class="btn">Registrati</button>
        </div>
        <div id="privateMessage" style="display: none;" class="small">Questo testo è stato impostato come privato.</div>
      </div>
    </div>
  </main>
  <footer>AleXShare v2.0</footer>
  <div id="draftIndicator" class="draft-indicator">Bozza salvata</div>
  <div id="confirmPanel" class="confirm-panel">
    <div id="confirmMessage"></div>
    <button id="confirmYes" class="btn">Sì</button>
    <button id="confirmNo" class="btn ghost">No</button>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCanlHzk_uRRSZQzug65OFkWbqWg3Q_Xik",
      authDomain: "project-chats-ef9a8.firebaseapp.com",
      projectId: "project-chats-ef9a8",
      storageBucket: "project-chats-ef9a8.appspot.com",
      messagingSenderId: "209738442357",
      appId: "1:209738442357:web:448eefd9651d0443ad3a3c",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    function randCode(length=10){
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()-_=+[]{};:,.<>?";
      let s="";
      crypto.getRandomValues(new Uint32Array(length)).forEach((v,i)=> s+=chars[v % chars.length]);
      return s.slice(0,length);
    }
    async function sha256str(str){
      const enc = new TextEncoder();
      const data = enc.encode(str);
      const hash = await crypto.subtle.digest('SHA-256', data);
      const arr = Array.from(new Uint8Array(hash));
      return arr.map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function show(el){ el.style.display = 'block'; }
    function hide(el){ el.style.display = 'none'; }

    async function apiCall(action, payload, requireAuth = true) {
      let headers = { "Content-Type": "application/json" };
      const bodyPayload = { database: "firestore", action, ...payload };
      if (!requireAuth) {
        bodyPayload.public = true;
      } else {
        const user = auth.currentUser;
        if (!user) throw new Error("Not logged in");
        const idToken = await user.getIdToken();
        headers.Authorization = `Bearer ${idToken}`;
      }
      const resp = await fetch("https://apisecurity-iota.vercel.app/api/universal", {
        method: "POST",
        headers,
        body: JSON.stringify(bodyPayload)
      });
      if (!resp.ok) {
        const json = await resp.json();
        throw new Error(json.error || "API error");
      }
      return (await resp.json()).data;
    }
    const burger = document.getElementById('burger');
    const side = document.getElementById('side');
    burger.addEventListener('click', () => {
      burger.classList.toggle('open');
      side.classList.toggle('open');
    });
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const signupBtn = document.getElementById('signupBtn');
    const loginBtn = document.getElementById('loginBtn');
    const afterRegister = document.getElementById('afterRegister');
    const generatedCodeEl = document.getElementById('generatedCode');
    const copyGenerated = document.getElementById('copyGenerated');
    const regCodeEl = document.getElementById('regCode');
    const copyReg = document.getElementById('copyReg');
    const logoutBtn = document.getElementById('logoutBtn');
    const userDisplay = document.getElementById('userDisplay');
    const userNotesEl = document.getElementById('userNotes');
    let currentRecoveryCode = null;
    let currentUserDocId = null;
    let currentOffset = 0;
    const mainContent = document.getElementById('mainContent');
    signupBtn.addEventListener('click', async () => {
      const username = usernameInput.value.trim();
      const pass = passwordInput.value;
      if (!username || username.length < 3 || username.length > 20 || !/^[a-zA-Z0-9_]+$/.test(username) || !pass) { 
        alert('Username non valido (3-20 chars, alfanumerico e _) e/o password mancante'); 
        return; 
      }
      try {
        const fakeEmail = encodeURIComponent(username) + "@alexshare.local";
        const userCredential = await auth.createUserWithEmailAndPassword(fakeEmail, pass);
        const uid = userCredential.user.uid;
        const code = randCode(10);
        currentRecoveryCode = code;
        generatedCodeEl.textContent = code;
        regCodeEl.textContent = code;
        const passHash = await sha256str(pass);
        await apiCall("setDoc", {
          collection: "alexshare_users",
          docId: uid,
          data: {
            username, 
            recoveryCode: code, 
            passHash, 
            createdAt: { _serverTimestamp: true }
          }
        }, true);
        show(afterRegister);
        alert('Registrazione completata. Salva il codice di recupero.');
      } catch (err) {
        alert('Errore: ' + err.message);
      }
    });
    copyGenerated.addEventListener('click', async () => {
      await navigator.clipboard.writeText(generatedCodeEl.textContent);
      copyGenerated.classList.add('animate-pulse');
      setTimeout(() => copyGenerated.classList.remove('animate-pulse'), 900);
    });
    copyReg.addEventListener('click', async () => {
      if (regCodeEl.textContent !== '—') {
        await navigator.clipboard.writeText(regCodeEl.textContent);
        copyReg.classList.add('animate-pulse');
        setTimeout(() => copyReg.classList.remove('animate-pulse'), 900);
      }
    });
    loginBtn.addEventListener('click', async () => {
      const username = usernameInput.value.trim();
      const pass = passwordInput.value;
      if (!username || !pass) { alert('Inserisci username e password'); return; }
      try {
        const fakeEmail = encodeURIComponent(username) + "@alexshare.local";
        await auth.signInWithEmailAndPassword(fakeEmail, pass);
      } catch (err) {
        alert('Errore login: ' + err.message);
      }
    });
    const forgotBtn = document.getElementById('forgotBtn');
    const recoveryStep = document.getElementById('recoveryStep');
    const recoveryInput = document.getElementById('recoveryInput');
    const recoverySubmit = document.getElementById('recoverySubmit');
    const resetStep = document.getElementById('resetStep');
    const newUser = document.getElementById('newUser');
    const newPass = document.getElementById('newPass');
    const doReset = document.getElementById('doReset');
    forgotBtn.addEventListener('click', () => show(recoveryStep));
    recoverySubmit.addEventListener('click', async () => {
      const code = recoveryInput.value.trim();
      if (!code) { alert('Inserisci codice'); return; }
      try {
        const items = await apiCall("getCollection", {
          collection: "alexshare_users",
          query: {
            where: [{ field: "recoveryCode", op: "==", value: code }],
            limit: 1
          }
        }, false);
        if (items.length === 0) { alert('Codice non trovato'); return; }
        currentUserDocId = items[0].id;
        hide(recoveryStep);
        show(resetStep);
      } catch (err) {
        alert('Errore: ' + err.message);
      }
    });
    doReset.addEventListener('click', async () => {
      if (!currentUserDocId) { alert('Errore'); return; }
      const nu = newUser.value.trim();
      const np = newPass.value;
      const updates = {};
      if (nu) {
        if (nu.length < 3 || nu.length > 20 || !/^[a-zA-Z0-9_]+$/.test(nu)) {
          alert('Nuovo username non valido (3-20 chars, alfanumerico e _)');
          return;
        }
        updates.username = nu;
      }
      if (np) {
        if (np.length < 8) { alert('Password troppo corta'); return; }
        updates.passHash = await sha256str(np);
      }
      if (Object.keys(updates).length === 0) { alert('Inserisci valori'); return; }
      try {
        await apiCall("updateDoc", {
          collection: "alexshare_users",
          docId: currentUserDocId,
          data: updates
        }, false);
        alert('Aggiornato con successo.');
        hide(resetStep);
      } catch (err) {
        alert('Errore: ' + err.message);
      }
    });
    const changeUsernameSection = document.getElementById('changeUsernameSection');
    const changePasswordSection = document.getElementById('changePasswordSection');
    const changeUsernameBtn = document.getElementById('changeUsername');
    const newUsernameInput = document.getElementById('newUsernameInput');
    const changePasswordBtn = document.getElementById('changePassword');
    const currentPasswordInput = document.getElementById('currentPasswordInput');
    const newPasswordInput = document.getElementById('newPasswordInput');
    changeUsernameBtn.addEventListener('click', async () => {
      const newU = newUsernameInput.value.trim();
      if (!newU || newU.length < 3 || newU.length > 20 || !/^[a-zA-Z0-9_]+$/.test(newU)) { 
        alert('Nuovo username non valido (3-20 chars, alfanumerico e _)'); 
        return; 
      }
      try {
        const newEmail = encodeURIComponent(newU) + "@alexshare.local";
        await auth.currentUser.updateEmail(newEmail);
        await apiCall("updateDoc", {
          collection: "alexshare_users",
          docId: auth.currentUser.uid,
          data: { username: newU }
        }, true);
        alert('Username cambiato con successo.');
        newUsernameInput.value = '';
        location.reload();
      } catch (err) {
        alert('Errore: ' + err.message);
      }
    });
    newPasswordInput.addEventListener('input', () => checkPasswordStrength(newPasswordInput.value, 'changePassStrength'));
    changePasswordBtn.addEventListener('click', async () => {
      const currentP = currentPasswordInput.value;
      const np = newPasswordInput.value;
      if (!currentP || !np) { alert('Inserisci password attuale e nuova password'); return; }
      try {
        const credential = firebase.auth.EmailPasswordAuthProvider.credential(auth.currentUser.email, currentP);
        await auth.currentUser.reauthenticateWithCredential(credential);
        await auth.currentUser.updatePassword(np);
        const passHash = await sha256str(np);
        await apiCall("updateDoc", {
          collection: "alexshare_users",
          docId: auth.currentUser.uid,
          data: { passHash }
        }, true);
        alert('Password cambiata con successo.');
        currentPasswordInput.value = '';
        newPasswordInput.value = '';
        document.getElementById('changePassStrength').style.display = 'none';
      } catch (err) {
        alert('Errore: ' + err.message);
      }
    });
    auth.onAuthStateChanged(async (user) => {
      mainContent.classList.add('visible');
      if (user) {
        show(document.getElementById('loggedInSettings'));
        hide(document.getElementById('notLoggedMenu'));
        try {
          const userData = await apiCall("getDoc", {
            collection: "alexshare_users",
            docId: user.uid
          }, true);
          if (userData) {
            const d = userData;
            const usernameFromEmail = d.username;
            userDisplay.textContent = `Benvenuto, ${usernameFromEmail}`;
            changeUsernameSection.classList.add('show');
            changePasswordSection.classList.add('show');
            regCodeEl.textContent = d.recoveryCode || '—';
            currentRecoveryCode = d.recoveryCode;
          } else {
            regCodeEl.textContent = '—';
            currentRecoveryCode = null;
          }
        } catch (err) {
          console.error('Errore caricamento user data:', err);
          regCodeEl.textContent = '—';
          currentRecoveryCode = null;
        }
        hide(document.getElementById('authContainer'));
        hide(document.getElementById('viewerContainer'));
        show(document.getElementById('editorContainer'));
        loadUserLinks(user.uid);
        tryLoadShared(true);
      } else {
        hide(document.getElementById('loggedInSettings'));
        show(document.getElementById('notLoggedMenu'));
        show(document.getElementById('authContainer'));
        hide(document.getElementById('editorContainer'));
        hide(document.getElementById('viewerContainer'));
        userDisplay.textContent = 'Non connesso';
        userNotesEl.innerHTML = '';
        changeUsernameSection.classList.remove('show');
        changePasswordSection.classList.remove('show');
        regCodeEl.textContent = '—';
        currentRecoveryCode = null;
        tryLoadShared(false);
      }
    });
    document.getElementById('sideLogin').addEventListener('click', () => {
      burger.click(); 
      loginBtn.click(); 
    });
    document.getElementById('sideSignup').addEventListener('click', () => {
      burger.click(); 
      signupBtn.click(); 
    });
    logoutBtn.addEventListener('click', () => auth.signOut());
    async function loadPage(uid) {
      try {
        const items = await apiCall("getCollection", {
          collection: "user_links",
          query: {
            where: [{ field: "owner", op: "==", value: uid }],
            orderBy: { field: "createdAt", direction: "desc" },
            limit: 5,
            offset: currentOffset
          }
        }, true);
        items.forEach((item) => {
          const title = item.title || 'Senza titolo';
          const date = item.createdAt ? new Date(item.createdAt).toLocaleDateString('it-IT') : 'Sconosciuta';
          const link = item.link;
          const div = document.createElement('div');
          div.className = 'note-item';
          div.innerHTML = `<a href="${link}" target="_blank">${title}</a> <small>${date}</small> <div class="icons"><span class="share-icon" data-link="${link}">📋</span><span class="copied-message">Link copiato per condividere</span><span class="edit-icon" data-id="${item.id}" data-title="${title}" data-link="${link}">✏️</span> <span class="delete-icon" data-id="${item.id}">❌</span></div>`;
          userNotesEl.appendChild(div);
        });
        const loadMoreBtn = document.getElementById('loadMoreLinks');
        if (items.length < 5) {
          hide(loadMoreBtn);
        } else {
          show(loadMoreBtn);
          currentOffset += 5;
        }
        if (currentOffset === 0 && items.length === 0) {
          userNotesEl.innerHTML = '<div class="small">Nessun link salvato</div>';
        }
      } catch (err) {
        console.error('Errore caricamento link:', err);
        userNotesEl.innerHTML = '<div class="small">Errore caricamento link: ' + err.message + '</div>';
      }
    }
    function loadUserLinks(uid) {
      currentOffset = 0;
      const loadMoreBtn = document.getElementById('loadMoreLinks');
      hide(loadMoreBtn);
      userNotesEl.innerHTML = '';
      loadPage(uid);
    }
    document.getElementById('loadMoreLinks').addEventListener('click', () => {
      const uid = auth.currentUser?.uid;
      if (uid) loadPage(uid);
    });
    const confirmPanel = document.getElementById('confirmPanel');
    const confirmMessage = document.getElementById('confirmMessage');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    let confirmCallback = null;
    function showConfirm(message, callback) {
      confirmMessage.textContent = message;
      confirmCallback = callback;
      show(confirmPanel);
    }
    confirmYes.addEventListener('click', () => {
      if (confirmCallback) confirmCallback();
      hide(confirmPanel);
    });
    confirmNo.addEventListener('click', () => {
      hide(confirmPanel);
    });
    userNotesEl.addEventListener('click', async (e) => {
      if (e.target.classList.contains('share-icon')) {
        const link = e.target.dataset.link;
        await navigator.clipboard.writeText(link);
        const copiedMessage = e.target.nextElementSibling;
        show(copiedMessage);
        setTimeout(() => hide(copiedMessage), 2000);
      } else if (e.target.classList.contains('edit-icon')) {
        const id = e.target.dataset.id;
        const currentTitle = e.target.dataset.title;
        const currentLink = e.target.dataset.link;
        showConfirm(`Sei sicuro di voler modificare "${currentTitle}"?`, async () => {
          const newTitle = prompt('Modifica titolo:', currentTitle);
          const newLink = prompt('Modifica link:', currentLink);
          if (newTitle && newTitle.length > 0 && newTitle.length <= 100 && newLink && newLink.length >= 10 && newLink.length <= 500 && newLink.startsWith('http')) {
            try {
              await apiCall("updateDoc", {
                collection: "user_links",
                docId: id,
                data: { title: newTitle, link: newLink }
              }, true);
              loadUserLinks(auth.currentUser.uid);
            } catch (err) {
              alert('Errore aggiornamento link: ' + err.message);
            }
          } else {
            alert('Titolo (1-100 chars) o link non valido (10-500 chars, inizia con http)');
          }
        });
      } else if (e.target.classList.contains('delete-icon')) {
        const id = e.target.dataset.id;
        const title = e.target.previousElementSibling.previousElementSibling.textContent;
        showConfirm(`Sei sicuro di voler eliminare "${title}"?`, async () => {
          try {
            await apiCall("deleteDoc", {
              collection: "user_links",
              docId: id
            }, true);
            loadUserLinks(auth.currentUser.uid);
          } catch (err) {
            alert('Errore eliminazione link: ' + err.message);
          }
        });
      }
    });
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const previewBtn = document.getElementById('previewBtn');
    const insertLink = document.getElementById('insertLink');
    const insertImage = document.getElementById('insertImage');
    const insertList = document.getElementById('insertList');
    const insertTable = document.getElementById('insertTable');
    const saveStatus = document.getElementById('saveStatus');
    let isSaved = false;
    let draftSaveTime = null;
    function updatePreview() {
      preview.innerHTML = marked.parse(editor.value || '');
      preview.classList.add('animate-fadeIn');
      setTimeout(() => preview.classList.remove('animate-fadeIn'), 500);
    }
    function updateSaveStatus() {
      if (isSaved) {
        saveStatus.textContent = 'Salvato – Ricorda di salvare il link nei tuoi link!';
      } else if (draftSaveTime) {
        saveStatus.textContent = `Salvato in bozza alle: ${draftSaveTime.toLocaleString('it-IT')}`;
      } else {
        saveStatus.textContent = 'Non salvato';
      }
    }
    previewBtn.addEventListener('click', () => {
      updatePreview();
      show(preview);
    });
    document.querySelectorAll('[data-act]').forEach(btn => {
      btn.addEventListener('click', () => {
        const act = btn.getAttribute('data-act');
        const selStart = editor.selectionStart, selEnd = editor.selectionEnd;
        const sel = editor.value.slice(selStart, selEnd);
        let insert = '';
        if (act === 'bold') insert = `**${sel || 'testo grassetto'}**`;
        if (act === 'italic') insert = `*${sel || 'testo italico'}*`;
        if (act === 'h1') insert = `# ${sel || 'Titolo 1'}\n`;
        if (act === 'h2') insert = `## ${sel || 'Titolo 2'}\n`;
        if (act === 'h3') insert = `### ${sel || 'Titolo 3'}\n`;
        if (act === 'quote') insert = `> ${sel || 'Citazione'}\n`;
        if (act === 'code') insert = `\`${sel || 'codice'}\``;
        if (act === 'codeblock') insert = '```\n' + (sel || 'codice blocco') + '\n```';
        editor.setRangeText(insert, selStart, selEnd, 'end');
        editor.focus();
        updatePreview();
      });
    });
    insertLink.addEventListener('click', () => {
      const url = prompt('URL?') || '';
      if (!url.startsWith('http')) {
        alert('URL deve iniziare con http');
        return;
      }
      const txt = prompt('Testo?') || 'link';
      editor.setRangeText(`[${txt}](${url})`, editor.selectionStart, editor.selectionEnd, 'end');
      updatePreview();
    });
    insertImage.addEventListener('click', () => {
      const url = prompt('URL immagine?') || '';
      if (!url.startsWith('http')) {
        alert('URL deve iniziare con http');
        return;
      }
      const alt = prompt('Testo alt?') || 'immagine';
      editor.setRangeText(`![${alt}](${url})`, editor.selectionStart, editor.selectionEnd, 'end');
      updatePreview();
    });
    insertList.addEventListener('click', () => {
      editor.setRangeText('- Voce 1\n- Voce 2\n- Voce 3\n', editor.selectionStart, editor.selectionEnd, 'end');
      updatePreview();
    });
    insertTable.addEventListener('click', () => {
      const table = '| Header1 | Header2 |\n|---------|---------|\n| Cella1 | Cella2 |\n';
      editor.setRangeText(table, editor.selectionStart, editor.selectionEnd, 'end');
      updatePreview();
    });
    const protectPwd = document.getElementById('protectPwd');
    const notePwd = document.getElementById('notePwd');
    const useExpiry = document.getElementById('useExpiry');
    const expiryDate = document.getElementById('expiryDate');
    const saveNote = document.getElementById('saveNote');
    const shareLink = document.getElementById('shareLink');
    const copyShare = document.getElementById('copyShare');
    const visibilitySelect = document.getElementById('visibilitySelect');
    const linkbox = document.querySelector('.linkbox');
    protectPwd.addEventListener('change', () => notePwd.style.display = protectPwd.checked ? 'block' : 'none');
    useExpiry.addEventListener('change', () => expiryDate.style.display = useExpiry.checked ? 'block' : 'none');
    saveNote.addEventListener('click', async () => {
      const content = editor.value.trim();
      if (!content || content.length > 50000) { alert('Testo troppo lungo o vuoto (max 50k chars)'); return; }
      const title = 'Nota senza titolo';
      const meta = {
        createdAt: { _serverTimestamp: true },
        title: title,
        visibility: visibilitySelect.value
      };
      if (protectPwd.checked) {
        const p = notePwd.value;
        if (!p) { alert('Inserisci password'); return; }
        meta.protected = true;
        meta.pwdHash = await sha256str(p);
      }
      if (useExpiry.checked && expiryDate.value) {
        meta.expiresAt = expiryDate.value;
      }
      meta.owner = auth.currentUser.uid;
      try {
        showSpinner('saveSpinner');
        const urlParams = new URLSearchParams(window.location.search);
        const pid = urlParams.get('p');
        let docRefId;
        if (pid) {
          await apiCall("updateDoc", {
            collection: "notes",
            docId: pid,
            data: { content, meta }
          }, true);
          docRefId = pid;
        } else {
          const result = await apiCall("addDoc", {
            collection: "notes",
            data: { content, meta }
          }, true);
          docRefId = result.id;
        }
        const url = window.location.origin + window.location.pathname + '?p=' + docRefId;
        shareLink.value = url;
        if (!pid) {
          show(linkbox);
        } else {
          if (url === window.location.href) {
            hide(linkbox);
          }
        }
        hide(saveNote);
        await navigator.clipboard.writeText(url);
        alert('Nota salvata e link copiato.');
        isSaved = true;
        updateSaveStatus();
        localStorage.removeItem('alexshare_draft');
        draftSaveTime = null;
      } catch (err) {
        alert('Errore: ' + err.message);
      } finally {
        hideSpinner('saveSpinner');
      }
    });
    copyShare.addEventListener('click', async () => {
      if (shareLink.value) {
        await navigator.clipboard.writeText(shareLink.value);
        copyShare.classList.add('animate-pulse');
        setTimeout(() => copyShare.classList.remove('animate-pulse'), 900);
      }
    });
    async function tryLoadShared(isOwner = false) {
      const urlParams = new URLSearchParams(window.location.search);
      const pid = urlParams.get('pid');
      if (!pid) return;
      try {
        const requireAuthForLoad = !!auth.currentUser;
        const data = await apiCall("getDoc", {
          collection: "notes",
          docId: pid
        }, requireAuthForLoad);
        if (!data) {
          if (isOwner) {
            preview.innerHTML = '<div class="small">Nota non trovata</div>';
          } else {
            document.getElementById('viewerPreview').innerHTML = '<div class="small">Nota non trovata</div>';
          }
          return;
        }
        const meta = data.meta || {};
        if (meta.expiresAt) {
          const expDate = new Date(meta.expiresAt);
          if (expDate < new Date()) {
            if (isOwner) {
              preview.innerHTML = '<div class="small">Nota scaduta</div>';
            } else {
              document.getElementById('viewerPreview').innerHTML = '<div class="small">Nota scaduta</div>';
            }
            return;
          }
        }
        if (meta.visibility === 'privata') {
          if (!auth.currentUser) {
            hide(document.getElementById('authContainer'));
            hide(document.getElementById('editorContainer'));
            show(document.getElementById('viewerContainer'));
            document.getElementById('viewerPreview').innerHTML = '';
            show(document.getElementById('privateMessage'));
            hide(document.getElementById('viewerPrompt'));
            hide(document.getElementById('viewerPasswordContainer'));
            return;
          } else if (auth.currentUser && auth.currentUser.uid !== meta.owner) {
            hide(document.getElementById('editorContainer'));
            show(document.getElementById('viewerContainer'));
            document.getElementById('viewerPreview').innerHTML = '';
            show(document.getElementById('privateMessage'));
            hide(document.getElementById('viewerPrompt'));
            hide(document.getElementById('viewerPasswordContainer'));
            return;
          }
        }
        if (meta.protected) {
          if (auth.currentUser && auth.currentUser.uid === meta.owner) {
            const p = prompt('Password richiesta:');
            if (!p || await sha256str(p) !== meta.pwdHash) {
              if (isOwner) {
                preview.innerHTML = '<div class="small">Password errata</div>';
              } else {
                document.getElementById('viewerPreview').innerHTML = '<div class="small">Password errata</div>';
              }
              return;
            }
          } else {
            if (auth.currentUser) {
              hide(document.getElementById('editorContainer'));
              show(document.getElementById('viewerContainer'));
            }
            show(document.getElementById('viewerPasswordContainer'));
            document.getElementById('viewerSubmitPassword').onclick = async () => {
              const p = document.getElementById('viewerPassword').value;
              if (!p || await sha256str(p) !== meta.pwdHash) {
                document.getElementById('viewerPreview').innerHTML = '<div class="small">Password errata</div>';
                return;
              }
              hide(document.getElementById('viewerPasswordContainer'));
              document.getElementById('viewerPreview').innerHTML = marked.parse(data.content || '');
              if (!auth.currentUser) {
                show(document.getElementById('viewerPrompt'));
              }
            };
            return;
          }
        }
        const contentHtml = marked.parse(data.content || '');
        if (isOwner) {
          if (auth.currentUser.uid === meta.owner) {
            editor.value = data.content || '';
            updatePreview();
            shareLink.value = window.location.href;
            show(linkbox);
            isSaved = true;
            updateSaveStatus();
          } else {
            hide(document.getElementById('editorContainer'));
            show(document.getElementById('viewerContainer'));
            document.getElementById('viewerPreview').innerHTML = contentHtml;
            if (!auth.currentUser) {
              show(document.getElementById('viewerPrompt'));
            }
          }
        } else {
          hide(document.getElementById('authContainer'));
          hide(document.getElementById('editorContainer'));
          show(document.getElementById('viewerContainer'));
          document.getElementById('viewerPreview').innerHTML = contentHtml;
          if (!auth.currentUser) {
            show(document.getElementById('viewerPrompt'));
          }
        }
      } catch (err) {
        if (isOwner) {
          preview.innerHTML = '<div class="small">Errore caricamento</div>';
        } else {
          document.getElementById('viewerPreview').innerHTML = '<div class="small">Errore caricamento</div>';
        }
      }
    }
    const toggleTheme = document.getElementById('toggleTheme');
    toggleTheme.addEventListener('click', () => {
      const body = document.body;
      if (body.getAttribute('data-theme') === 'light') {
        body.setAttribute('data-theme', 'dark');
        toggleTheme.textContent = 'Light';
      } else {
        body.setAttribute('data-theme', 'light');
        toggleTheme.textContent = 'Dark';
      }
      localStorage.setItem('theme', body.getAttribute('data-theme'));
    });
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.body.setAttribute('data-theme', savedTheme);
      toggleTheme.textContent = savedTheme === 'dark' ? 'Light' : 'Dark';
    }
    function checkPasswordStrength(password, containerId) {
      const container = document.getElementById(containerId);
      if (!container) return;
      const strengthBar = container.querySelector('.password-strength');
      if (!password) {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';
      let strength = 0;
      if (password.length >= 8) strength += 1;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;
      if (/\d/.test(password)) strength += 1;
      if (/[^a-zA-Z\d]/.test(password)) strength += 1;
      strengthBar.className = 'password-strength';
      if (strength < 2) strengthBar.classList.add('strength-weak');
      else if (strength < 4) strengthBar.classList.add('strength-medium');
      else strengthBar.classList.add('strength-strong');
      strengthBar.style.width = (strength / 4 * 100) + '%';
    }
    function updateWordCount() {
      const text = editor.value;
      const words = text.trim().split(/\s+/).filter(w => w.length > 0).length;
      const chars = text.replace(/[\s\n]/g, '').length;
      document.getElementById('wordCount').textContent = `${words} parole | ${chars} caratteri`;
    }
    let draftTimeout;
    function saveDraft() {
      const draft = editor.value;
      if (draft) {
        localStorage.setItem('alexshare_draft', draft);
        draftSaveTime = new Date();
        updateSaveStatus();
        showDraftIndicator();
      }
    }
    function loadDraft() {
      const draft = localStorage.getItem('alexshare_draft');
      if (draft && !editor.value) {
        editor.value = draft;
        updatePreview();
        updateWordCount();
      }
    }
    function showDraftIndicator() {
      const indicator = document.getElementById('draftIndicator');
      indicator.classList.add('show');
      setTimeout(() => indicator.classList.remove('show'), 2000);
    }
    function showSpinner(id) {
      document.getElementById(id).style.display = 'inline-block';
    }
    function hideSpinner(id) {
      document.getElementById(id).style.display = 'none';
    }
    document.getElementById('clearFormat').addEventListener('click', () => {
      editor.setRangeText('', editor.selectionStart, editor.selectionEnd, 'end');
      updatePreview();
      editor.focus();
    });
    document.getElementById('exportMarkdown').addEventListener('click', () => {
      const blob = new Blob([editor.value], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'nota.md';
      a.click();
      URL.revokeObjectURL(url);
    });
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 'b':
            e.preventDefault();
            document.querySelector('[data-act="bold"]').click();
            break;
          case 'i':
            e.preventDefault();
            document.querySelector('[data-act="italic"]').click();
            break;
          case 's':
            e.preventDefault();
            saveNote.click();
            break;
        }
      }
    });
    const visibilityIcon = document.getElementById('visibilityIcon');
    const visibilityTooltip = document.getElementById('visibilityTooltip');
    visibilityIcon.addEventListener('mouseover', () => {
      visibilityTooltip.classList.add('show');
    });
    visibilityIcon.addEventListener('mouseout', () => {
      visibilityTooltip.classList.remove('show');
    });
    visibilityIcon.addEventListener('click', () => {
      visibilityTooltip.classList.toggle('show');
    });
    const addLinkBtn = document.getElementById('addLink');
    const linkTitleInput = document.getElementById('linkTitle');
    const linkUrlInput = document.getElementById('linkUrl');
    addLinkBtn.addEventListener('click', async () => {
      const title = linkTitleInput.value.trim();
      const link = linkUrlInput.value.trim();
      if (!title || title.length > 100 || !link || link.length < 10 || link.length > 500 || !link.startsWith('http')) { 
        alert('Titolo (1-100 chars) o link non valido (10-500 chars, inizia con http)'); 
        return; 
      }
      try {
        await apiCall("addDoc", {
          collection: "user_links",
          data: {
            owner: auth.currentUser.uid,
            title,
            link,
            createdAt: { _serverTimestamp: true }
          }
        }, true);
        linkTitleInput.value = '';
        linkUrlInput.value = '';
        loadUserLinks(auth.currentUser.uid);
      } catch (err) {
        alert('Errore: ' + err.message);
      }
    });
    const viewerLoginBtn = document.getElementById('viewerLoginBtn');
    const viewerSignupBtn = document.getElementById('viewerSignupBtn');
    const redirectToAuth = () => {
      window.location.href = window.location.origin + window.location.pathname;
    };
    viewerLoginBtn.addEventListener('click', redirectToAuth);
    viewerSignupBtn.addEventListener('click', redirectToAuth);
    passwordInput.addEventListener('input', () => checkPasswordStrength(passwordInput.value, 'passwordStrength'));
    newPass.addEventListener('input', () => checkPasswordStrength(newPass.value, 'newPasswordStrength'));
    notePwd.addEventListener('input', () => checkPasswordStrength(notePwd.value, 'notePasswordStrength'));
    editor.addEventListener('input', () => {
      updateWordCount();
      if (isSaved) {
        isSaved = false;
        updateSaveStatus();
        show(saveNote);
      }
      clearTimeout(draftTimeout);
      draftTimeout = setTimeout(saveDraft, 60000);
    });
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    saveDraftBtn.addEventListener('click', () => {
      saveDraft();
    });
    const newNoteBtn = document.getElementById('newNote');
    newNoteBtn.addEventListener('click', () => {
      if (editor.value && !isSaved) {
        if (!confirm('Non hai salvato le modifiche. Continuare comunque?')) {
          return;
        }
      }
      editor.value = '';
      hide(linkbox);
      hide(preview);
      isSaved = false;
      draftSaveTime = null;
      updateSaveStatus();
      updateWordCount();
      localStorage.removeItem('alexshare_draft');
      show(saveNote);
    });
    window.addEventListener('load', () => {
      loadTheme();
      loadDraft();
      updateWordCount();
      updateSaveStatus();
    });
  </script>
</body>
</html>
